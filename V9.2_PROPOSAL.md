# V9.2 Implementation Proposal: Food Acquisition vs Corner/Body Avoidance

## Executive Summary

Deep analysis of game 4 from optimized_v9.1.2.jsonl revealed a cascade of conservative decisions that led to death by starvation. The issue was NOT a single bug, but three interacting problems:

1. **Turn 82 (health=18):** Opponent body segments at distance 2 caused avoidance of distance-2 food
2. **Turn 86-87 (health=14-13):** Conservative space control pushed bot toward corner
3. **Turn 87 (health=13):** CRITICAL - Adjacent food ignored due to search depth/timing issue (replay mismatch)

## Problem Analysis

### Problem 1: Opponent Body Proximity Overweighting (Turn 82)

**Situation:**
- Position: (2, 2), Health: 18
- Food at (2, 0) - distance 2
- Opponent head at (1, 5) - distance 4 (not threatening)
- **Opponent body at (2, 4) - distance 2** (blocking perceived path)

**Current Behavior:**
- Search tree predicts trap/danger from opponent body
- Chooses UP (away from food) instead of DOWN (toward food)
- Replay MATCHED - current code makes same decision

**Root Cause:**
- Adversarial entrapment detection (`compute_space_score`) considers ALL opponent body segments
- Doesn't distinguish between:
  - **Threatening bodies**: Near our path to food, opponent head could trap us
  - **Non-threatening bodies**: Distant opponent head, body is static obstacle

### Problem 2: Corner Danger Not Health-Aware (Turn 86-87)

**Situation:**
- Turn 87: Position (1, 0), Health: 13 (CRITICAL!)
- Food at (2, 0) - distance 1 (ADJACENT!)
- All opponent heads 6+ moves away (NO THREATS)
- Chose LEFT → corner (0, 0) instead of RIGHT → eat food

**Current Behavior:**
```rust
fn compute_corner_danger(pos: Coord, width: i32, height: i32, config: &Config) -> i32 {
    if min_corner_dist <= config.scores.corner_danger_threshold {
        -(config.scores.corner_danger_base / (min_corner_dist + 1))
    } else {
        0
    }
}
```
- At distance 1 from corner: -2500 penalty
- This penalty is CONSTANT regardless of health
- At health=13 with food adjacent, survival should override corner danger

**Root Cause:**
- Corner danger penalty doesn't scale with health urgency
- At critical health (<20), accepting corner risk to eat food is acceptable trade-off

### Problem 3: Search Depth Inconsistency (Turn 87)

**Situation:**
- Replay shows: Original LEFT vs Replay RIGHT (MISMATCH)
- Replay reached depth 2 in 375ms
- During live play, may have been shallower depth due to time pressure

**Root Cause:**
- Time estimation may have been too conservative for this board state
- Search cutoff prevented seeing food value at depth 2+

## Proposed Solution

### Change 1: Opponent Body Threat Filtering

**Location:** `src/bot.rs:2064-2150` (adversarial entrapment in `compute_space_score`)

**Concept:** Only consider opponent bodies "threatening" if:
1. Opponent head is within reasonable distance (≤ current distance to food + 2)
2. OR: Body segment is directly blocking our path to food (within 2 cells of food)

**Implementation:**
```rust
// NEW: Check if opponent is actually threatening before considering body segments
fn is_opponent_threatening(
    opponent_idx: usize,
    our_head: Coord,
    nearest_food: Option<Coord>,
    board: &Board,
) -> bool {
    if opponent_idx >= board.snakes.len() {
        return false;
    }

    let opponent = &board.snakes[opponent_idx];
    if opponent.health <= 0 || opponent.body.is_empty() {
        return false;
    }

    let opp_head = opponent.body[0];
    let head_distance = manhattan_distance(our_head, opp_head);

    // Opponent is threatening if head is close enough to actively trap us
    // Use a threshold based on food distance if available
    let threat_distance = if let Some(food) = nearest_food {
        let food_dist = manhattan_distance(our_head, food);
        // Opponent is threatening if they can reach food area before/with us
        (food_dist + 2).min(6)  // Cap at 6 to avoid considering very distant snakes
    } else {
        4  // Default: consider heads within 4 moves as threats
    };

    head_distance <= threat_distance
}

// MODIFY: In compute_space_score, filter opponents before checking entrapment
fn compute_space_score(
    board: &Board,
    snake_idx: usize,
    active_snakes: &[usize],
    config: &Config,
) -> i32 {
    // ... existing reachable space calculation ...

    // Find nearest food for threat assessment
    let nearest_food = if !board.food.is_empty() && !snake.body.is_empty() {
        let head = snake.body[0];
        board.food.iter()
            .min_by_key(|&&food| manhattan_distance(head, food))
            .copied()
    } else {
        None
    };

    // Adversarial entrapment: check if nearby opponents can reduce our space
    for &opp_idx in active_snakes {
        if opp_idx == snake_idx {
            continue;
        }

        // V9.2: Only consider threatening opponents
        if !Self::is_opponent_threatening(opp_idx, snake.body[0], nearest_food, board) {
            continue;
        }

        // ... rest of adversarial entrapment logic ...
    }

    // ... rest of function ...
}
```

**Expected Impact:**
- Turn 82: Opponent at distance 4 would NOT be considered threatening for distance-2 food
- Bot should prioritize food over avoiding distant opponent bodies
- Reduces false-positive "trap" predictions

### Change 2: Health-Aware Corner Danger

**Location:** `src/bot.rs:2362-2384` (`compute_corner_danger`)

**Concept:** Scale corner danger penalty by health urgency:
- High health (>50): Full penalty (conservative play)
- Medium health (20-50): Reduced penalty (accept some risk)
- Critical health (<20): Minimal penalty (survival priority)

**Implementation:**
```rust
/// Computes corner danger penalty with health-aware scaling
/// V9.2: At critical health, accept corner risk if necessary for food
fn compute_corner_danger(
    pos: Coord,
    width: i32,
    height: i32,
    health: i32,
    config: &Config,
) -> i32 {
    // Distance to nearest corner
    let corners = [
        (0, 0),
        (0, height - 1),
        (width - 1, 0),
        (width - 1, height - 1),
    ];

    let min_corner_dist = corners
        .iter()
        .map(|&(cx, cy)| (pos.x - cx).abs() + (pos.y - cy).abs())
        .min()
        .unwrap_or(999);

    // Apply penalty when within threshold
    if min_corner_dist <= config.scores.corner_danger_threshold {
        let base_penalty = config.scores.corner_danger_base / (min_corner_dist + 1);

        // V9.2: Scale penalty by health urgency
        // At critical health (<20), accept corner risk for food
        // At low health (20-50), reduce penalty to 50%
        // At high health (>50), full penalty
        let health_scale = if health < 20 {
            0.2  // 20% of normal penalty at critical health
        } else if health < 50 {
            0.5  // 50% of normal penalty at low health
        } else {
            1.0  // Full penalty at high health
        };

        -(base_penalty as f32 * health_scale) as i32
    } else {
        0
    }
}
```

**Call Site Change:**
```rust
// Line ~2964: Update compute_corner_danger call to pass health
let (wall_penalty, center_bias, corner_danger) = if !snake.body.is_empty() {
    let head = snake.body[0];
    (
        Self::compute_wall_penalty(head, board.width as i32, board.height as i32, snake.health, config),
        Self::compute_center_bias(head, board.width as i32, board.height as i32, config),
        Self::compute_corner_danger(head, board.width as i32, board.height as i32, snake.health, config),  // ADD health param
    )
} else {
    (0, 0, 0)
};
```

**Expected Impact:**
- Turn 87 with health=13: Corner penalty reduced from -2500 to -500
- Food bonus (37.5B with max multiplier) would dominate corner penalty
- Bot would choose RIGHT (eat food) over LEFT (corner)

### Change 3: Even More Aggressive Food Multipliers at Critical Health

**Location:** `src/bot.rs:1917-1976` (urgency multiplier logic)

**Concept:** Current V9.1.2 uses max multiplier for distance-2 food when health < 50. This wasn't aggressive enough at health=13-18. Need:
- Distance 2: Max multiplier when health < 30 (not just < 50)
- Distance 1: Already uses max multiplier (good!)

**Implementation:**
```rust
} else if nearest_food_dist == 2 {
    // Distance 2: Check if we have clear advantage
    let nearest_opponent_dist = active_snakes.iter()
        .filter_map(|&opp_idx| {
            if opp_idx == snake_idx || opp_idx >= board.snakes.len() {
                return None;
            }
            let opp = &board.snakes[opp_idx];
            if opp.health <= 0 || opp.body.is_empty() {
                return None;
            }
            nearest_food.map(|f| manhattan_distance(opp.body[0], f))
        })
        .min()
        .unwrap_or(999);

    // V9.2: More aggressive at critical health
    if snake.health < 30 {
        // Critical health (<30): ALWAYS use max multiplier for distance-2 food
        // This is more conservative than V9.1.2's <50 threshold
        config.scores.survival_max_multiplier
    } else if snake.health < 50 {
        // Low health (30-50): Use max multiplier only if clear advantage
        if nearest_opponent_dist >= nearest_food_dist + 3 {
            config.scores.survival_max_multiplier
        } else {
            // Reduce from 0.8 to ensure we still pursue when health is dropping
            config.scores.survival_max_multiplier * 0.6
        }
    } else if nearest_opponent_dist >= nearest_food_dist + 3 {
        // High health but clear advantage: use high multiplier
        config.scores.survival_max_multiplier * 0.8
    } else {
        // Contested: moderate multiplier
        config.scores.survival_max_multiplier * 0.2
    }
}
```

**Expected Impact:**
- Turn 82 (health=18): Still below 30 threshold, would use max multiplier
- Turn 87 (health=13): Max multiplier for distance-1 already in place
- Combined with corner danger fix, should prioritize food more aggressively

## Testing Strategy

### 1. Regression Testing
```bash
# Build with changes
cargo build --release

# Replay game 4 to verify fixes
./target/release/replay tests/fixtures/optimized_v9.1.2/game_04.jsonl --turns 82,86,87 --verbose

# Expected results:
# Turn 82: May still choose UP (depth-dependent), but score should favor DOWN more
# Turn 86: Should avoid corner (choose LEFT or RIGHT instead of DOWN)
# Turn 87: Should choose RIGHT (eat food) instead of LEFT (corner)
```

### 2. Full Game Analysis
```bash
# Play new games
# Set debug.log_file_path = "optimized_v9.2.jsonl" in Snake.toml

# After games complete:
./target/release/split_games optimized_v9.2.jsonl
./target/release/analyze_food_pursuit tests/fixtures/optimized_v9.2/

# Target: <5% food aversion rate (down from V9.1.2's ~11%)
```

### 3. Death Analysis
```bash
./target/release/analyze_deaths tests/fixtures/optimized_v9.2/

# Target: Fewer starvation deaths, similar or lower trap/collision deaths
```

## Risk Assessment

### Low Risk Changes
1. **Health-aware corner danger** - Clear improvement with minimal downside
   - At high health, behavior unchanged
   - At low health, accepts necessary risk for survival

### Medium Risk Changes
2. **Opponent body threat filtering** - May miss some legitimate traps
   - Mitigation: Keep threshold generous (food_dist + 2)
   - Monitoring: Check if we start dying to "obvious" traps

3. **Critical health threshold change** (50 → 30 for distance-2)
   - May make us slightly more conservative at health 30-50
   - But health 13-18 cases (like game 4) will be more aggressive

## Version Numbering

**Proposed: V9.2 - Health-Aware Risk Assessment**

Rationale: This is a significant behavioral change in how we assess risk vs reward at different health levels, warranting a minor version bump.

## Configuration Changes

**Snake.toml additions:**
```toml
# Adversarial Entrapment Constants (UPDATED)
# Distance threshold to consider opponent head as "nearby threat"
# V9.2: Now used in threat filtering - only opponents within this distance are considered
adversarial_entrapment_distance = 4

# Opponent Body Threat Threshold
# V9.2: NEW parameter for filtering non-threatening opponent bodies
# Only consider opponent bodies threatening if head is within (food_distance + this value)
adversarial_body_threat_buffer = 2
```

## Implementation Checklist

- [ ] Add `is_opponent_threatening()` helper function
- [ ] Modify `compute_space_score()` to filter opponents
- [ ] Update `compute_corner_danger()` signature and logic
- [ ] Update `compute_corner_danger()` call site to pass health
- [ ] Adjust distance-2 food multiplier thresholds (50 → 30)
- [ ] Add new config parameters to `Snake.toml`
- [ ] Add corresponding fields to `src/config.rs`
- [ ] Update `GAPS.md` with V9.2 section
- [ ] Build and test with replay tool
- [ ] Run full game analysis
- [ ] Compare death patterns V9.1.2 vs V9.2
